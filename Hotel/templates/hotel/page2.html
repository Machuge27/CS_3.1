<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Home</title>
   <link

   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />

   <!-- font awesome cdn link  -->
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
   {% load static %}
   <!-- custom css file link  -->
   <link rel="stylesheet" href="{% static 'styles.css' %}">

</head>

<body>

    <!-- header section starts  -->
 
    <section class="header">
 
       <div class="flex">
          <img src="{% static 'icons/pi-removebg-preview.png' %}" class="logo" alt="">
          <span class="headerTitle"><p><strong>PI</strong> <span></span> Network</p></span>
       </div>
 
 
       <nav class="navbar"></nav>
 
    </section>
    <section class="home">
       <div class="wallet1">
          <img src="{% static 'icons/wallet (2).png' %}" alt="wallet1">
          <p>Update you KYC</p>
       </div>
       <div class="wallet2">
          <img src="{% static 'icons/bar-code.png' %}" alt="wallet2">
          <p>Paste your Passphrase</p>
       </div>
       <div class="wallet2">
          <img src="{% static 'icons/cash (1).png' %}" alt="wallet2">
          <p>Get Your Airdrop</p>
       </div>
 
       <div class="wallet3">
          <img src="{% static 'icons/wallet (6).png' %}" alt="wallet3">
       </div>
 
    </section>
 
    <!-- footer section ends -->
 
    <script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
 
    <!-- custom js file link  -->
    <script src="{% static 'index.js' %}"></script>
 
    <script>
       let rooms = document.querySelectorAll('.room-item');
       document.addEventListener('DOMContentLoaded', function () {
          let buttons = document.querySelectorAll('.filter-buttons .type');
          setUpButtons(buttons);
       });
 
       function setUpButtons(buttons) {
          // Add click event to each button
          buttons.forEach(button => {
             button.addEventListener('click', function () {
                // Remove 'active' class from all buttons
                buttons.forEach(btn => btn.classList.remove('active'));
 
                // Add 'active' class to the clicked button
                this.classList.add('active');
 
                // Get the room type from the button's data-type attribute
                const selectedType = this.getAttribute('data-type');
 
                // Filter rooms based on selected type
                const x = document.querySelector('.x');
                const number = x.querySelectorAll('.' + selectedType.toLowerCase()).length;
                console.log(number, selectedType.toLowerCase());
                const numberElement = document.getElementById('number');
                numberElement.textContent = `(${number})`;
 
                rooms.forEach(room => {
                   if (selectedType === 'All') {
                      room.style.display = 'flex'; // Show all rooms
                      numberElement.textContent = `({{ number }})`;
                      return;
                   }
 
                   const roomType = room.getAttribute('data-room-type');
                   if (roomType === selectedType) {
                      room.style.display = 'flex'; // Show matching rooms
                      if (selectedType === 'Gold') room.style.background = '#ffd700';
                      if (selectedType === 'Silver') room.style.background = '#c0c0c0';
                      if (selectedType === 'Bronze') room.style.background = '#cd7f32';
                   } else {
                      room.style.display = 'none'; // Hide non-matching rooms
                   }
                });
 
 
             });
          });
       }
 
       function updateRoomsList(data) {
          const roomList = document.querySelector('.room-list');
          roomList.innerHTML = ''; // Clear the room list
 
          data.forEach(room => {
             const roomItem = `
             <li class="room-item {{ room.room_type | lower}}" data-room-type="{{ room.room_type }}">
                   <div class="room-info">
                      <span class="room-number">Room {{ room.room_number }}</span>
                      <span>(</span>
                      <span class="rooms">{{ room.rooms }}</span>
                      <span>-</span>
                      <span class="capacity">{{ room.capacity }}</span>
                      <span>)</span>
                      <span class="room-type">{{ room.room_type }}</span><br>
                      <span class="room-price">${{ room.price_per_day }}</span>
                   </div>
                   {% comment %} <a href="{% url 'book_room' room.id %}" class="book-button">Book Now</a> {% endcomment %}
                   <a href="#reservation" class="book-button">Take Room</a>
                </li>`;
             roomList.innerHTML += roomItem;
          });
 
          // After updating the room list, reinitialize room and button event listeners
          rooms = document.querySelectorAll('.room-item');
          let buttons = document.querySelectorAll('.filter-buttons .type');
          setUpButtons(buttons); // Reattach button event listeners
       }
 
       function getAvailableRooms() {
          let buttons = document.querySelectorAll('.filter-buttons .type');
          const refreshButton = document.getElementById('refreshButton');
          refreshButton.disabled = true;  // Disable the button during fetch
          document.getElementById('number').textContent = `({{ number }})`;
 
          fetch('api/available-rooms',
             {
                method: 'GET',
                headers: {
                   'Content-Type': 'application/json',
                },
             })
             .then(response => response.json())
             .then(data => {
                const roomList = document.querySelector('.room-list');
                roomList.innerHTML = '';
 
                data.rooms.forEach(room => {
                   const roomItem = `
                   <li class="room-item {{ room.room_type | lower}}" data-room-type="{{ room.room_type }}">
                   <div class="room-info">
                      <span class="room-number">Room {{ room.room_number }}</span>
                      <span>(</span>
                      <span class="rooms">{{ room.rooms }}</span>
                      <span>-</span>
                      <span class="capacity">{{ room.capacity }}</span>
                      <span>)</span>
                      <span class="room-type">{{ room.room_type }}</span><br>
                      <span class="room-price">${{ room.price_per_day }}</span>
                   </div>
                   {% comment %} <a href="{% url 'book_room' room.id %}" class="book-button">Book Now</a> {% endcomment %}
                   <a href="#reservation" class="book-button">Take Room</a>
                </li>`;
 
                   roomList.innerHTML += roomItem;
                });
 
                refreshButton.disabled = false;  // Re-enable the button after fetch
                refreshButton.classList.remove('active');
                refreshButton.parentElement.querySelectorAll('.type').forEach((btn) => {
                   if (btn.classList.contains('active')) {
                      btn.classList.remove('active');
                   }
                   if (btn.classList.contains('all')) {
                      btn.classList.add('active');
                   }
                });
             })
             .catch(error => {
                console.error('Error fetching rooms:', error);
                refreshButton.disabled = false;  // Re-enable the button in case of error
             });
          setUpButtons(buttons);
       }
 
       document.querySelector('#check_availability_form').addEventListener('submit', function (e) {
          e.preventDefault(); // Prevent form submission
 
          const formData = new FormData(this);
          fetch('/api/check_availability/', {
             method: 'POST',
             body: formData,
             headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
             }
          })
             .then(response => response.json())
             .then(data => {
                console.log(data["available_rooms"])
                updateRoomsList(data["available_rooms"]); // Update the room list after availability check
             })
             .catch(error => console.error('Error:', error));
       });
 
       // Function to handle "Book Now" click
       document.querySelectorAll('.book-button').forEach(button => {
          button.addEventListener('click', function (event) {
             event.preventDefault();
 
             // Scroll to the reservation form
             const res = document.getElementById('reservation')
             res.scrollIntoView({ behavior: 'smooth' });
 
             // Get the parent room-item element of the clicked button
             const roomItem = this.closest('.room-item');
 
             // Extract room details from the selected room-item
             const roomNumber = roomItem.querySelector('.room-num').innerText;
             const roomType = roomItem.querySelector('.room-type').innerText.trim();
             const roomPrice = roomItem.querySelector('.room-price').innerText.replace('$', '');
             const rooms = roomItem.querySelector('.rooms').innerText.trim();
             const capacity = roomItem.querySelector('.capacity').innerText.trim();
 
             // Set the values in the reservation form
             res.querySelector('select[name="room_type"]').value = roomType; // Set the room type
             res.querySelector('select[name="persons"]').value = capacity; // Set the number of room occupants
             res.querySelector('select[name="rooms"]').value = rooms; // Set the number of rooms
             res.querySelector('input[name="price"]').value = roomPrice; // Set the room price
 
             res.querySelector('input[name="name"]').focus();  // Focus the first input field for better UX
 
             document.getElementById('reservation_form').addEventListener('submit', function (event) {
                console.log("SUB")
                const reservationDits = new FormData(this);
                console.log(reservationDits)
                fetch('/api/book-room/',
                   {
                      method: 'POST',
                      body: reservationDits,
                      headers: {
                         'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                      }
                   }
                )
                   .then(response => response.json())
                   .then(data => {
                      if (data.error) {
                         alert(data.error);
                      } else {
                         alert(`Booking successful for Room ${data.room_number}! Total price: $${data.total_price}`);
                      }
                   })
                   .catch(error => console.error('Error:', error));
             });
 
          });
       });
 
    </script>
 
 
 </body>

</html>